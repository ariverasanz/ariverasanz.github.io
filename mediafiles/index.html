<HTML>
    <head>
        <script>
            Date.prototype.addMilisecons = function(ms) {
                this.setTime(this.getTime() + ms);
                return this;
            }

            Date.prototype.substract = function(dt) {
                return this-dt;
            }

            const waitFor = delay => new Promise(resolve => setTimeout(resolve, delay));
            const waitUntil = date => new Promise(resolve => setTimeout(resolve, date - Date.now()));

            const precacheMiliseconds = 5000;
            const disposeMiliseconds = 1000;

            window.onload = function () {
                console.log(ObjPL);
                player(ObjPL);

                    

/*
                obj={
                    'src': 'image3.jpg',
                    'mime': 'image/jpeg',
                    'when':  new Date(new Date().addMilisecons(3000)).toISOString(),
                    'where': 'box'
                }
                scheduleContent(obj);

                obj={
                    'src': 'CountDown10s.mp4',
                    'mime': 'video/mp4',
                    'when':  new Date(new Date().addMilisecons(13000)).toISOString(),
                    'where': 'box'
                }

                scheduleContent(obj);

                obj={
                    'src': 'image3.jpg',
                    'mime': 'image/jpeg',
                    'when':  new Date(new Date().addMilisecons(16000)).toISOString(),
                    'where': 'box'
                }
                scheduleContent(obj);
*/
            }

            async function player(objPlaylist){
                while (true) {
                    content=objPlaylist[0];
                    if (content) {
                        console.log(new Date(content.when).substract(new Date()));
                        if (new Date(content.when).substract(new Date()) < 0){
                            objPlaylist.shift();
                            console.log("In the past, skipping");
                            continue;
                        }
                        else if (new Date(content.when).substract(new Date()) < 10000) {
                            objPlaylist.shift();
                            console.log("Sheduling ", content);
                            scheduleContent(content);
                        }
                        else console.log("Next loop, waiting");
                    }
                    else console.log("No playlist, waiting");
                    await waitFor(1000);
                }
            }

            function setTimeoutVideo(objVideo){
                objVideo.play();
                for (const child of objVideo.parentElement.children) {
                    if (child === objVideo) child.style['z-index'] = 2
                    else child.style['z-index'] = 1;
                    console.log(child);
                }
            }

            function scheduleVideo(content){
                var video = document.createElement('video');

                video.muted = 'muted'
                video.preload = 'auto';
                video.autoplay = false;
                video.src = content.src;
                video.style['position'] = "absolute";
                video.style['z-index'] = "1";

                const box = document.getElementById(content.where);
                box.appendChild(video);

                //set video to stop on last frame
                video.addEventListener('ended', function() {
                    this.pause();
                    this.currentTime = this.duration;
                }, false);

                var timeToPlay = new Date(content.when) - new Date();
                if (timeToPlay > 0) {
                    console.log(timeToPlay);
                    return waitFor(() => {setTimeoutVideo(video)},timeToPlay);
                }

            }

            function setTimeoutImage(objImage){
                for (const child of objImage.parentElement.children) {
                    if (child === objImage) child.style['z-index'] = 2
                    else child.style['z-index'] = 1;
                    console.log(child);

                }
            }

            function scheduleImage(content){
                var image = document.createElement('img');

                image.src = content.src;
                image.style['position'] = "absolute";
                image.style['z-index'] = "1";

                const box = document.getElementById(content.where);
                box.appendChild(image);

                var timeToPlay = new Date(content.when) - new Date();
                if (timeToPlay > 0) {
                    console.log(timeToPlay);
                    return waitFor(() => {setTimeoutImage(image)},timeToPlay);
                }

            }

            function scheduleContent(content){
                if (content.mime == 'video/mp4')
                    return scheduleVideo(content)
                else if (content.mime == 'image/jpeg')
                    return scheduleImage(content);
            }

            

        </script>
        <script src="list.js"></script>
    </head>
    <body style="background-color:black;">
        <div id="box">
        </div>
    </body>
</HTML>