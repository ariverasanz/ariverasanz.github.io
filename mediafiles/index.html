<HTML>
    <head>
        <script>
            Date.prototype.addMilisecons = function(ms) {
                this.setTime(this.getTime() + ms);
                return this;
            }

            Date.prototype.substract = function(dt) {
                return this-dt;
            }

            const waitFor = delay => new Promise(resolve => setTimeout(resolve, delay));
            const waitUntil = date => new Promise(resolve => setTimeout(resolve, date - Date.now()));



            const precacheMiliseconds = 5000;
            const disposeMiliseconds = 1000;

            window.onload = function () {
                console.log(ObjPL);
                player(ObjPL);

                    // (function () {
                    //     var old = console.log;
                    //     var logger = document.getElementById('log');
                    //     console.log = function (...messages) {
                    //         for (let message of messages){
                    //             if (typeof message == 'object') {
                    //                 logger.innerHTML += (JSON && JSON.stringify ? JSON.stringify(message) : message) + '<br />';
                    //             } else {
                    //                 logger.innerHTML += message;
                    //             }
                    //         }
                    //     }
                    //     logger.innerHTML += '<br />';
                    // })();
            }

            async function player(objPlaylist){
                while (true) {
                    const content=objPlaylist[0];
                    if (!content) {
                        console.log("No playlist, waiting");
                        await waitFor(1000);
                        continue;
                    }
                    if (new Date(content.when).substract(new Date()) < 0){
                        console.log("Slot in the past, skipping");
                        objPlaylist.shift();
                        continue;
                    }
                    if (new Date(content.when).substract(new Date()) < precacheMiliseconds) {
                        console.log("Sheduling ", content);
                        objPlaylist.shift();
                        scheduleContent(content);
                        continue;
                    }
                    await waitUntil(new Date(content.when).addMilisecons(-precacheMiliseconds));
                }
            }

            function precacheContent(content){
                if (content.mime == 'video/mp4'){
                    var newElement = document.createElement('video');
                    newElement.id = content.uuid;
                    newElement.muted = 'muted'
                    newElement.preload = 'auto';
                    newElement.autoplay = false;
                    newElement.src = content.src;
                    newElement.style['position'] = "absolute";
                    newElement.style['z-index'] = "1";
                    //set video to stop on last frame
                    newElement.addEventListener('ended', function() {
                        this.pause();
                        this.currentTime = this.duration;
                    }, false);
                    const box = document.getElementById(content.where);
                    box.appendChild(newElement);
                }
                else if (content.mime == 'image/jpeg'){
                    var newElement = document.createElement('img');
                    newElement.id = content.uuid;
                    newElement.src = content.src;
                    newElement.style['position'] = "absolute";
                    newElement.style['z-index'] = "1";
                    const box = document.getElementById(content.where);
                    box.appendChild(newElement);
                }
            }

            function playContent(content){
                const objElement = document.getElementById(content.uuid);
                if (content.mime == 'video/mp4'){
                    objElement.play();
                    for (const child of objElement.parentElement.children) {
                        if (child === objElement) child.style['z-index'] = 2
                        else child.style['z-index'] = 1;
                    }
                }
                else if (content.mime == 'image/jpeg'){
                    for (const child of objElement.parentElement.children) {
                        if (child === objElement) child.style['z-index'] = 2
                        else child.style['z-index'] = 1;
                    }
                }
            }

            function disposeContent(content){
                if (content.mime == 'video/mp4')
                    return true ; //scheduleVideo(content)
                else if (content.mime == 'image/jpeg')
                    return true; //scheduleImage(content);
            }

            async function scheduleContent(content){
                precacheContent(content);
                await waitUntil(new Date(content.when));
                playContent(content);
                await waitUntil(new Date(content.when).addMilisecons(disposeMiliseconds));
                disposeContent(content);
            }

            

        </script>
        <script src="list.js"></script>
    </head>
    <body style="background-color:black;">
        <div id="box">
        </div>
        <div id="log" style="z-index: 100; color: bisque;">
        </div>
    </body>
</HTML>